<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="style.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>
		$(document).ready(function() {
			var pn = $('#projectname');
			var bugsarray = {};

			function prettyPrint(arr) {
				var dumped = "";
				if(typeof(arr) == 'object') { //Array/Hashes/Objects 
					for(var item in arr) {
						var value = arr[item];
						if(typeof(value) == 'object') {
							dumped += '<div class="bug">';
							dumped += '<span class="number">'+value.id+'</span>';
							dumped += '<span class="summary" title="'+value.description+'">'+value.summary+'</span>';
							dumped += '<div class="masdatos hidden">';

							dumped += '<div><span class="bolded-text">Description:</span> '+value.description+'</div>';
							dumped += '<div><span class="bolded-text">Reporter:</span> '+value.reporter.name+'</div>';
							
							dumped += '</div>';
							dumped += '</div>'; 
						}
					}
				}
				return dumped;
			}

			$('.form').live('submit', function(e) {
				e.preventDefault();

				if( ! pn.val()) {
					$('.errormessage').fadeIn('slow');
					$('.errormessage').removeClass('hidden');
					$('.errormessage').html('Write the name of the project first');
				}
				else {
					$.get('mantis/connectMantis.php', {projectname: pn.val()}, function(e) {
						try {
							var object = eval('(' + e + ')');

							if(object.error) {
								console.log(object.error);
								$('.errormessage').fadeIn('slow');
								$('.errormessage').removeClass('hidden');
								$('.errormessage').html(object.error);
								return false;
							}
							
							$("#content").html('');

							$('.version').prepend('Mantis Connect version: '+object.version);

							bugsarray = object.result;
							$('#content').prepend('<button id="migrate">Move all to Zendesk</button>');
							$('#content').prepend('<div class="buglist">'+prettyPrint(object.result)+'</div>');
							$('#content').prepend('<div class="title">Bug list</div>');

							$('#content').fadeIn('slow');														
						}
						catch(error) {
							console.log(error);
							$('.errormessage').fadeIn('slow');
							$('.errormessage').removeClass('hidden');
							$('.errormessage').html('Error on the response');
						}
					});
				}

				return false;
			});

			$('.errormessage').live('click', function(e) {
				if(!$(this).hasClass('hidden')) {
					$(this).fadeOut('slow');
				}
			});

			$('.bug').live('click', function(e) {
				var masdatos = $(this).children('.masdatos');
				if(masdatos) {
					if(masdatos.hasClass('hidden')) {
						masdatos.slideDown();
						masdatos.removeClass('hidden');
					}
					else {
						masdatos.slideUp();
						masdatos.addClass('hidden');
					}
				}
			});

			$('#migrate').live('click', function(e) {
                var jsonbugs = JSON.stringify(bugsarray);
				console.log(jsonbugs);
                $.post('zendesk/zdticket.php', {arrayBugs: bugsarray}, function(e) {
                    console.log(e);
                });
			});
		});
	</script>

</head>
<body>
    <div class="centered-container">
        <div class="container">
            <title>Mantis bug migration</title>
            <header>
                <div class="logo"></div>
                <div class="logo-title">Mantis bug migration</div>
            </header>

            <div id="content">
                <div class="title">Type the project name</div>
                <div>Check the settings.php file to set your mantis endpoint</div>
                <form class="form" action="#">
                    <input id="projectname" type="text" name="projectname" placeholder="Project Name">
                    <input type="submit">
                </form>
                <div class="errormessage hidden"></div>
            </div>

        </div>
        <footer class="version">
            <div class="famfam">
                <a href="http://www.famfamfam.com/lab/icons/silk/">Icons by Mark James</a>
            </div>
        </footer>
    </div>
</body>
</html>